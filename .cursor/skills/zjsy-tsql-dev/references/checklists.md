# 珠江实业 T-SQL 脚本检查清单（交付/上线前）

## 通用（任何 .sql 都要）
- [ ] **目标清晰**：脚本头部注释包含“目的/影响对象/参数/口径/回滚”。\n- [ ] **可复现**：说明依赖的库名、表名、版本号口径（例如 `version` 字段格式）。\n- [ ] **可验证**：包含执行前后对账查询；写入/更新后能解释影响行数（`@@ROWCOUNT` 或聚合统计）。\n- [ ] **不误伤**：`WHERE` 条件足够严格；避免忘记过滤导致全表更新/全表插入。\n- [ ] **幂等性**：重复执行是否安全？如果不安全，需要显式说明并给出防重逻辑（例如先删同版本数据、或 MERGE/NOT EXISTS）。\n\n## 报表/查询脚本\n+- [ ] **口径一致**：实时与快照两分支字段集合一致、字段名/别名一致。\n- [ ] **性能**：\n  - [ ] 避免 `WHERE CONVERT(...)`、`DATEDIFF(...)` 套在列上导致不可走索引（可改为范围条件）。\n  - [ ] 大表聚合优先分段到临时表 `#`，并在最后清理。\n- [ ] **金额单位**：是否 `/10000.0`、是否含税/不含税、税率是否 `*0.01` 统一。\n\n## 存储过程/作业（快照类）\n+- [ ] **基本设置**：`SET NOCOUNT ON;`、必要的 `ANSI_NULLS/QUOTED_IDENTIFIER`。\n- [ ] **日志完整**：每个子任务至少写入一次 Started/Completed/Failed；失败记录 `ERROR_MESSAGE()`。\n- [ ] **失败可见**：`CATCH` 里 `THROW;`（不要吞异常）。\n- [ ] **临时表治理**：创建前先 drop、结束后 drop。\n- [ ] **AffectedRows 可信**：记录 `@@ROWCOUNT` 时，注意它是“上一条语句”的行数；避免被后续语句覆盖。\n\n## 数据治理/修复脚本\n+- [ ] **先备份**：\n  - [ ] 建议 `SELECT INTO <table>_bakYYYYMMDD` 或使用快照/备份策略。\n  - [ ] 备份范围与修复范围一致（同一 `WHERE`）。\n- [ ] **事务策略**：\n  - [ ] 小范围可用单事务；大范围优先分批更新，避免长事务锁表。\n  - [ ] `TRY...CATCH` 里确保 `ROLLBACK`。\n- [ ] **回滚可执行**：回滚语句/步骤明确且与备份表字段一致。\n- [ ] **变更说明**：记录修复原因、验证结果、影响行数。\n\n## 关于 WITH(NOLOCK)\n+- [ ] **默认不滥用**：只在“报表容忍脏读/不可重复读/幻读”的场景考虑。\n+- [ ] **风险已知**：如果用了 `WITH(NOLOCK)`，在注释里说明可能出现的脏读与不一致风险。\n\n## 交付建议（给业务/同事）\n+- [ ] **交付包**：\n  - [ ] 1 个 `.sql`（含注释、对账、主逻辑、回滚）\n  - [ ] 简短的变更说明（目的、口径、执行步骤、验证口径、风险点）\n+
